!function(e,t,n){"use strict";angular.module("koast",["koast-user","koast-resource","koast-versionCheck"]).run(function(){if(typeof _==typeof n)throw new Error("_ is undefined. koast-angular requires underscore or lodash to be loaded")}),angular.module("koast-resource",["koast-user"]),angular.module("koast-resource").factory("_KoastEndpoint",[function(){function e(e,t,n,r){var o=this;o.prefix=e,o.handle=t,o.template=n,o.options=_.clone(r)}function t(e,t){return t?e.replace(/:([-_a-zA-Z]*)/g,function(e,n){var r=t[n],o=r||0===r;if(!o)throw new Error("Missing parameter: "+n);return t[n]}):""}return e.prototype.makePostUrl=function(){return this.prefix+this.handle},e.prototype.makeGetUrl=function(e){return this.makePostUrl()+"/"+t(this.template,e)},e}]),angular.module("koast-resource").factory("_koastResourceGetter",["_KoastResource","_KoastServerHelper","_KoastEndpoint","$http","$q","$log","_koastHttp",function(e,t,n,r,o,a,u){function s(t,n){var r=_.map(t,function(t){return new e(n.endpoint,t,n)});return n.singular&&(0===r.length?r=null:r.length>1?(a.warn("Expected a singular resource, got "+r.length),r=r[0]):r=r[0]),r}function i(e,n,r,o){var a=d[e],i={},c={},l={params:r,headers:i};if(c=angular.extend(c,a.options),c=angular.extend(c,o),c.endpoint=a,!a)throw new Error("Unknown endpoint: "+e);return t.addAuthHeaders(i),u.get(a.makeGetUrl(n),l).then(function(e){return s(e,c)})}function c(e,n,a){var u=o.defer(),s=d[e],i={};if(a=a||{},!s)throw new Error("Unknown endpoint: "+e);return t.addAuthHeaders(i),r.post(s.makePostUrl(),n,{headers:i}).success(function(e){u.resolve(e)}).error(function(e){u.reject(e)}),u.promise}var l={},f={},d={},p={};return l.setApiUriPrefix=function(e,t){t=t||"_",f[t]=e},l.getResource=function(e,t){return i(e,t,null,{singular:!0})},l.createResource=function(e,t){return c(e,t).then(null,a.error)},l.queryForResources=function(e,t){return i(e,null,t)},l.addEndpoint=function(e,t,r){r=r||{};var o=r.server||"_",a=f[o];if(!a)throw new Error("No URI prefix defined for server "+o);var u=new n(a,e,t,r);if(d[e])throw new Error("An endpoint with this handle was already defined: "+e);d[e]=u},l.init=function(e){p=e},l}]),angular.module("koast-resource").factory("_KoastResource",["_KoastServerHelper","$q","$http","$log",function(e,t,n,r){function o(e,t,n){var r,o=this;if(n.useEnvelope){if(r=t.data,!r)throw new Error("Client expects an envelope, but server did not send it properly.")}else r=t;return _.keys(r).forEach(function(e){o[e]=r[e]}),n.useEnvelope&&Object.defineProperty(this,"can",{get:function(){return t.meta.can}}),Object.defineProperty(this,"_endpoint",{get:function(){return e}}),this}return o.prototype.save=function(){var t=this._endpoint.makeGetUrl(this),r={};return e.addAuthHeaders(r),n.put(t,this,{headers:r})},o.prototype.delete=function(){r.debug("The endpoint: ",this._endpoint);var t=this._endpoint.makeGetUrl(this);r.debug("delete url:",t);var o={};return e.addAuthHeaders(o),n.delete(t,{headers:o})},o}]),angular.module("koast-resource").factory("_KoastServerHelper",["_koastUser","_koastTokenKeeper",function(e,t){var n={};return n.addAuthHeaders=function(n){e.isSignedIn&&(n["koast-auth-token"]=e.meta.token,n["koast-auth-token-timestamp"]=e.meta.timestamp,n["koast-user"]=angular.toJson(e.data)),n.Authorization="Bearer "+t.loadToken()},n}]),angular.module("koast").constant("peerDependencies",{koast:">=0.4.5"}),angular.module("koast").factory("koast",["_koastUser","_koastResourceGetter","$log","_koastHttp","versionCheck",function(e,t,n,r,o){var a={},u=["setApiUriPrefix","getResource","createResource","queryForResources","addEndpoint"];return a.user=e,u.forEach(function(e){a[e]=t[e]}),a.init=function(a){n.info("Initializing koast."),r.setOptions(a),e.init(a),t.init(a),o.isCompatible()},a}]),angular.module("koast-user",["koast-logger","koast-http"]),angular.module("koast-user").factory("_koastOauth",["$window","$location","$log","_koastLogger",function(e,t,n,r){function o(e,t){return s+"/auth/"+e+"?next="+encodeURIComponent(t)}var a="Koast_Post_Auth_Url",u={},s=t.absUrl().split("/").slice(0,3).join("/");return u.setNextUrl=function(t){e.localStorage.setItem(a,t)},u.clearNextUrl=function(){e.localStorage.removeItem(a)},u.getNextUrl=function(){return e.localStorage.getItem(a)},u.initiateAuthentication=function(n,r){u.setNextUrl(r);var a=o(n,t.absUrl());e.location.replace(a)},u.setBaseUrl=function(e){s=e},u.makeRequestURL=function(e){return e||(e=""),s+e},u}]),angular.module("koast-user").factory("_koastUser",["_koastOauth","_koastHttp","_koastLogger","$log","$timeout","$http","$window","$q","$location",function(e,t,n,r,o,a,u,s,i){function c(e){var t=v.debug.delay;return t?(r.debug("Delayng for "+t+" msec."),o(function(){return e},t)):e}function l(e){var t=e&&e.data;return k.debug("Setting the user based on",e),t?(e.isAuthenticated&&(k.info("response body is",e),k.info("response body data is",e.data),k.info("response body meta is",e.meta),v.data=e.data,v.meta=e.meta,v.meta.token&&m.saveToken({token:v.meta.token,expires:v.meta.expires}),b.resolve()),v.isAuthenticated=e.isAuthenticated):(k.warn("Did not get back a valid user record.",e),v.data={},v.isAuthenticated=!1,v.meta={}),v.isReady=!0,v.isAuthenticated}function f(e){return e&&!v.meta.isRegistered&&g?o(g,0).then(function(){return e}):e}function d(){var t=e.getNextUrl();return e.clearNextUrl(),t?void i.url(t):{}}function p(e){return m.get(e||"/auth/user").then(null,function(e){if(401===e.status)return null;throw e}).then(c).then(l).then(f)}var g,h,k=n.makeLogger("koast.user"),m=t,v={isAuthenticated:!1,isReady:!1,data:{},meta:{}},b=s.defer();return v.getUserData=p,v.saveToken=function(e,t){m.saveToken({token:e,expires:t})},v.initiateOauthAuthentication=function(t,n){e.initiateAuthentication(t,n)},v.logout=function(t){return m.deleteToken(),a.post(e.makeRequestURL("/auth/logout")).then(function(e){if("Ok"!==e.data)throw new Error("Failed to logout.");u.location.replace(t||"/")}).then(null,function(e){throw r.error(e),e})},v.loginLocal=function(t){r.debug("Login:",t.username);var n={username:t.username,password:t.password};return a.post(e.makeRequestURL("/auth/login"),n).then(function(e){return k.debug("loginLocal:",e),e.data}).then(l)},v.registerSocial=function(e){return m.put("/auth/user",e).then(function(e){return e.meta.token&&v.saveToken(e.meta.token,e.meta.expires),p()})},v.registerLocal=function(t){return a.post(e.makeRequestURL("/auth/user"),t)},v.checkUsernameAvailability=function(e){var t="/auth/usernameAvailable";return m.get(t,{params:{username:e}}).then(function(e){return e.data===!0}).then(null,function(){})},v.resetPassword=function(t){return a.post(e.makeRequestURL("/forgot"),{email:t})},v.setNewPassword=function(t,n){return a.post(e.makeRequestURL("/reset/"+n),{password:t})},v.setRegistrationHanler=function(e){g=e},v.getStatusPromise=function(){return h||(h=p()),h},v.whenStatusIsKnown=v.getStatusPromise,v.refreshToken=function(e,t){return m.get(e||"/auth/token/refresh").then(function(e){return e.token?(v.meta.token=e.token,e):t})},v.checkForToken=function(){var e=i.search().redirectToken;return e?(v.saveToken(e),v.refreshToken(null,e).then(function(e){return v.saveToken(e.token,e.expires)})):s.when({})},v.init=function(t){return t.debug=t.debug||{},v.debug=t.debug,e.setBaseUrl(t.baseUrl),v.checkForToken().then(v.getStatusPromise).then(d)},v.whenAuthenticated=function(){return b.promise},v}]),angular.module("koast-versionCheck",["koast-http","koast-logger"]).factory("versionCheck",["_koastHttp","peerDependencies","$log",function(e,t,n){function r(e){var t=e.isCompatible?n.info:n.error;return t(e.isCompatible?"Current version of kaost-angular is compatible with server":"Current version of kaost-angular is not compatible with server"),t("isCompatible",e.isCompatible),t("koast server version:",e.koastVersion),t("koast-angular compatible versions:",e.checkedVersion),e}function o(n){return n=n||t.koast,n=encodeURIComponent(n),e.get(a+n).then(r)}var a="/meta/koast-angular/check-compatability?koast-version=";return{isCompatible:o}}]),function(e){function t(r){if(n[r])return n[r].exports;var o=n[r]={exports:{},id:r,loaded:!1};return e[r].call(o.exports,o,o.exports,t),o.loaded=!0,o.exports}var n={};return t.m=e,t.c=n,t.p="",t(0)}([function(e,t,n){function r(e){return angular.module(e,["koast-setup"])}function o(e){return function(){return e.getService()}}var a=n(1);angular.module("koast-setup",[]).factory("_koastSetup",["$q","$http",function(e,t){a.set("q",e),a.set("http",t)}]),r("koast-logger").factory("_koastLogger",o(n(2))),r("koast-http").factory("_koastHttp",o(n(3))).factory("_koastTokenKeeper",o(n(4))),console.log("124")},function(e,t){var n={};t.set=function(e,t){console.log("setting ",e),n[e]=t},t.get=function(e){return n[e]}},function(e,t,n){function r(){function e(e,t,r){if(e=arguments[0]||{},!(e.level&&e.level<n)){var o=e.color||"black",a=[];r=Array.prototype.slice.call(r,0);var u=[];"string"==typeof r[0]&&(u.push("%c"+r.shift()),a.push("color:"+o+";")),t.groupName&&(u.unshift("%c["+t.groupName+"]"),a.unshift("color:gray;")),e.symbol&&(u.unshift("%c"+e.symbol),a.unshift("color:"+o+";font-weight:bold;font-size:150%;")),a.unshift(u.join(" ")),a=a.concat(r),Function.prototype.apply.call(console.log,console,a)}}function t(t){return t.level=a.levels[t.name],function(n,r){e(t,n,r)}}a={},a.levels={debug:1,verbose:2,info:3,warn:4,error:5};var n=3;a.colors={},a.setLogLevel=function(e){n=e};var r={debug:t({name:"debug",color:"gray",symbol:"✍"}),verbose:t({name:"verbose",color:"cyan",symbol:"☞"}),info:t({name:"info",color:"#0074D9",symbol:"☞"}),warn:t({name:"warn",color:"orange",symbol:"⚐"}),error:t({name:"error",color:"red",symbol:"⚑"})},o=["debug","verbose","info","warn","error"];a.makeLogger=function(e){var t={};return"string"==typeof e&&(e={groupName:e}),t.options=e,o.forEach(function(e){t[e]=function(){var n=arguments;return r[e](t.options,n)}}),t};var u=a.makeLogger({});return o.forEach(function(e){a[e]=u[e]}),a}console.log("logger loaded");var o=n(1);console.log("inj:",o),console.log("q:",o.get("q"));var a;t.getService=function(){return a||r()}},function(e,t,n){function r(){function e(){l.headers=l.headers||{},f&&(l.headers.Authorization="Bearer "+f)}function t(){return d.when()}function n(n){return t().then(function(){e()}).then(n).then(function(e){return r.isReachable=!0,e.data?e.data:e}).then(null,function(e){throw c.warn(e.data||e),e})}var r={},o=u.getService(),i=s.getService(),c=o.makeLogger("koast.http"),l={timeout:3e4},f=i.loadToken(),d=a.get("q"),p=a.get("http");return c.debug("Loaded token",f),r.setOptions=function(e){l=e},r.saveToken=function(e){f=e.token,i.saveToken(e)},r.deleteToken=function(){i.clear()},r.post=function(e,t,r){return r=_.cloneDeep(r)||l,r.baseUrl=l.baseUrl||"",r.method="POST",r.data=t,n(function(){var t=_.cloneDeep(r);return t.url=r.baseUrl+e,t.params=r.params,p(t)})},r.put=function(e,t,r){return r=_.cloneDeep(r)||l,r.baseUrl=l.baseUrl||"",r.method="PUT",r.data=t,n(function(){var t=_.cloneDeep(r);return t.url=r.baseUrl+e,t.params=r.params,p(t)})},r.get=function(e,t){return t=_.cloneDeep(t)||l,t.baseUrl=l.baseUrl||"",t.method="GET",n(function(){var n=_.cloneDeep(t);return n.url=t.baseUrl+e,n.params=t.params,p(n)})},r}var o,a=n(1),u=n(2),s=n(4);t.getService=function(){return o||r()}},function(t,n,r){function o(){a={};var t=u.getService(),n=t.makeLogger("koast.token-keeper");return n.info("Initializing token keeper"),a.saveToken=function(t){var n=t.token||t;e.localStorage.setItem(s,n)},a.loadToken=function(){return e.localStorage.getItem(s)},a.clear=function(){return e.localStorage.removeItem(s)},a}console.log("token-keeper");var a,u=r(2),s="KoastToken";n.getService=function(){return a||o()}}])}(window,document);