"use strict";angular.module("koast.http",[]).factory("_koastTokenKeeper",["$log","$window",function(e,t){var n="KoastToken",r={};return r.saveToken=function(e){var r=e.token||e;t.localStorage.setItem(n,r)},r.loadToken=function(){return t.localStorage.getItem(n)},r.clear=function(){return t.localStorage.removeItem(n)},r}]).factory("_koastHttp",["$http","$q","_koastLogger","_koastTokenKeeper",function(e,t,n,r){function o(){c.headers=c.headers||{},l&&(c.headers.Authorization="Bearer "+l)}function a(){return t.when()}function i(e){return a().then(function(){o()}).then(e).then(function(e){return s.isReachable=!0,e.data?e.data:e}).then(null,function(e){throw u.warn(e.data||e),e})}var u=n.makeLogger("koast.http"),s={},c={timeout:3e4},l=r.loadToken();return u.debug("Loaded token",l),s.setOptions=function(e){c=e},s.saveToken=function(e){l=e.token,r.saveToken(e)},s.deleteToken=function(){r.clear()},s.post=function(t,n,r){return r=_.cloneDeep(r)||c,r.baseUrl=c.baseUrl||"",r.method="POST",r.data=n,i(function(){var n=_.cloneDeep(r);return n.url=r.baseUrl+t,n.params=r.params,e(n)})},s.put=function(t,n,r){return r=_.cloneDeep(r)||c,r.baseUrl=c.baseUrl||"",r.method="PUT",r.data=n,i(function(){var n=_.cloneDeep(r);return n.url=r.baseUrl+t,n.params=r.params,e(n)})},s.get=function(t,n){return n=_.cloneDeep(n)||c,n.baseUrl=c.baseUrl||"",n.method="GET",i(function(){var r=_.cloneDeep(n);return r.url=n.baseUrl+t,r.params=n.params,e(r)})},s}]),angular.module("koast",["koast-user","koast-resource"]).factory("koast",["_koastUser","_koastResourceGetter","$log","_koastHttp",function(e,t,n,r){var o={},a=["setApiUriPrefix","getResource","createResource","queryForResources","addEndpoint"];return o.user=e,a.forEach(function(e){o[e]=t[e]}),o.init=function(o){n.info("Initializing koast."),r.setOptions(o),e.init(o),t.init(o)},o}]),angular.module("koast.logger",[]).factory("_koastLogger",[function(){function e(e,t,n){if(e=arguments[0]||{},!(e.level&&e.level<r)){var o=e.color||"black",a=[];n=Array.prototype.slice.call(n,0);var i=[];"string"==typeof n[0]&&(i.push("%c"+n.shift()),a.push("color:"+o+";")),t.groupName&&(i.unshift("%c["+t.groupName+"]"),a.unshift("color:gray;")),e.symbol&&(i.unshift("%c"+e.symbol),a.unshift("color:"+o+";font-weight:bold;font-size:150%;")),a.unshift(i.join(" ")),a=a.concat(n),Function.prototype.apply.call(console.log,console,a)}}function t(t){return t.level=n.levels[t.name],function(n,r){e(t,n,r)}}var n={};n.levels={debug:1,verbose:2,info:3,warn:4,error:5};var r=3;n.colors={},n.setLogLevel=function(e){r=e};var o={debug:t({name:"debug",color:"gray",symbol:"✍"}),verbose:t({name:"verbose",color:"cyan",symbol:"☞"}),info:t({name:"info",color:"#0074D9",symbol:"☞"}),warn:t({name:"warn",color:"orange",symbol:"⚐"}),error:t({name:"error",color:"red",symbol:"⚑"})},a=["debug","verbose","info","warn","error"];n.makeLogger=function(e){var t={};return"string"==typeof e&&(e={groupName:e}),t.options=e,a.forEach(function(e){t[e]=function(){var n=arguments;return o[e](t.options,n)}}),t};var i=n.makeLogger({});return a.forEach(function(e){n[e]=i[e]}),n}]),angular.module("koast-persona",[]).factory("_koastPersona",["$http","$q","$interval","$location","$log",function(e,t,n,r,o){function a(){var e,r=window.document,o=r.getElementsByTagName("head")[0],a=r.createElement("script"),i=t.defer();return a.type="text/javascript",a.async=!0,a.src="https://login.persona.org/include.js",o.appendChild(a),e=n(function(){window.navigator.id&&(i.resolve(),n.cancel(e))},50),i.promise}function i(t){o.debug("verifyAssertion:");var n=r.absUrl().split("/").slice(0,3).join("/")+"/",a={assertion:t,audience:n};o.info("audience:",n);var i={timeout:5e3};return e.post("/auth/browserid",a,i).then(function(e){return o.debug("Response:",e),e.data}).then(null,function(e){throw"object"==typeof e&&e.headers?(o.error("Persona verification timed out."),new Error("Persona verification timed out.")):(o.error("Error verifying Persona assertion:",e.toString()),o.error(e.stack),e)})}var u={},s=!1,c=t.defer();return u.initiateSignIn=function(e){e||(e={}),o.debug("signIn"),s=!0,navigator.id.request({siteName:e.siteTitle,oncancel:function(){o.info("Persona login cancelled by user.")}})},u.initiateSignOut=function(){s=!0,navigator.id.logout()},u.init=function(e){return a().then(function(){o.debug("navigator.id.watch added"),navigator.id.watch({loggedInUser:null,onlogin:function(t){s&&i(t).then(function(t){e.onSignIn(t)},o.error)},onlogout:function(){s&&e.onSignOut()},onready:function(){c.resolve()}})}).then(null,o.error),c.promise},u.whenReady=function(){return c.promise},u}]),angular.module("koast-resource",["koast-user"]).factory("_KoastServerHelper",["_koastUser","_koastTokenKeeper",function(e,t){var n={};return n.addAuthHeaders=function(n){e.isSignedIn&&(n["koast-auth-token"]=e.meta.token,n["koast-auth-token-timestamp"]=e.meta.timestamp,n["koast-user"]=angular.toJson(e.data)),n.Authorization="Bearer "+t.loadToken()},n}]).factory("_KoastResource",["_KoastServerHelper","$q","$http","$log",function(e,t,n,r){function o(e,t,n){var r,o=this;if(n.useEnvelope){if(r=t.data,!r)throw new Error("Client expects an envelope, but server did not send it properly.")}else r=t;return _.keys(r).forEach(function(e){o[e]=r[e]}),n.useEnvelope&&Object.defineProperty(this,"can",{get:function(){return t.meta.can}}),Object.defineProperty(this,"_endpoint",{get:function(){return e}}),this}return o.prototype.save=function(){var t=this._endpoint.makeGetUrl(this),r={};return e.addAuthHeaders(r),n.put(t,this,{headers:r})},o.prototype.delete=function(){r.debug("The endpoint: ",this._endpoint);var t=this._endpoint.makeGetUrl(this);r.debug("delete url:",t);var o={};return e.addAuthHeaders(o),n.delete(t,{headers:o})},o}]).factory("_KoastEndpoint",[function(){function e(e,t,n,r){var o=this;o.prefix=e,o.handle=t,o.template=n,o.options=_.clone(r)}function t(e,t){return t?e.replace(/:([-_a-zA-Z]*)/g,function(e,n){var r=t[n],o=r||0===r;if(!o)throw new Error("Missing parameter: "+n);return t[n]}):""}return e.prototype.makePostUrl=function(){return this.prefix+this.handle},e.prototype.makeGetUrl=function(e){return this.makePostUrl()+"/"+t(this.template,e)},e}]).factory("_koastResourceGetter",["_KoastResource","_KoastServerHelper","_KoastEndpoint","$http","$q","$log","_koastHttp",function(e,t,n,r,o,a,i){function u(t,n){var r=_.map(t,function(t){return new e(n.endpoint,t,n)});return n.singular&&(0===r.length?r=null:r.length>1?(a.warn("Expected a singular resource, got "+r.length),r=r[0]):r=r[0]),r}function s(e,n,r,o){var a=d[e],s={},c={},l={params:r,headers:s};if(c=angular.extend(c,a.options),c=angular.extend(c,o),c.endpoint=a,!a)throw new Error("Unknown endpoint: "+e);return t.addAuthHeaders(s),i.get(a.makeGetUrl(n),l).then(function(e){return u(e,c)})}function c(e,n,a){var i=o.defer(),u=d[e],s={};if(a=a||{},!u)throw new Error("Unknown endpoint: "+e);return t.addAuthHeaders(s),r.post(u.makePostUrl(),n,{headers:s}).success(function(e){i.resolve(e)}).error(function(e){i.reject(e)}),i.promise}var l={},f={},d={},h={};return l.setApiUriPrefix=function(e,t){t=t||"_",f[t]=e},l.getResource=function(e,t){return s(e,t,null,{singular:!0})},l.createResource=function(e,t){return c(e,t).then(null,a.error)},l.queryForResources=function(e,t){return s(e,null,t)},l.addEndpoint=function(e,t,r){r=r||{};var o=r.server||"_",a=f[o];if(!a)throw new Error("No URI prefix defined for server "+o);var i=new n(a,e,t,r);if(d[e])throw new Error("An endpoint with this handle was already defined: "+e);d[e]=i},l.init=function(e){h=e},l}]),angular.module("koast-user",["koast.logger","koast.http"]).factory("_koastOauth",["$window","$location","$log","_koastLogger",function(e,t,n,r){function o(e,t){return u+"/auth/"+e+"?next="+encodeURIComponent(t)}var a="Koast_Post_Auth_Url",i={},u=t.absUrl().split("/").slice(0,3).join("/");return i.setNextUrl=function(t){e.localStorage.setItem(a,t)},i.clearNextUrl=function(){e.localStorage.removeItem(a)},i.getNextUrl=function(){return e.localStorage.getItem(a)},i.initiateAuthentication=function(n,r){i.setNextUrl(r);var a=o(n,t.absUrl());e.location.replace(a)},i.setBaseUrl=function(e){u=e},i.makeRequestURL=function(e){return e||(e=""),u+e},i}]).factory("_koastUser",["_koastOauth","_koastHttp","_koastLogger","$log","$timeout","$http","$window","$q","$location",function(e,t,n,r,o,a,i,u,s){function c(e){var t=v.debug.delay;return t?(r.debug("Delayng for "+t+" msec."),o(function(){return e},t)):e}function l(e){var t=e&&e.data;return m.debug("Setting the user based on",e),t?(e.isAuthenticated&&(m.info("response body is",e),m.info("response body data is",e.data),m.info("response body meta is",e.meta),v.data=e.data,v.meta=e.meta,v.meta.token&&k.saveToken({token:v.meta.token,expires:v.meta.expires}),b.resolve()),v.isAuthenticated=e.isAuthenticated):(m.warn("Did not get back a valid user record.",e),v.data={},v.isAuthenticated=!1,v.meta={}),v.isReady=!0,v.isAuthenticated}function f(e){return e&&!v.meta.isRegistered&&g?o(g,0).then(function(){return e}):e}function d(){var t=e.getNextUrl();return e.clearNextUrl(),t?void s.url(t):{}}function h(e){return k.get(e||"/auth/user").then(null,function(e){if(401===e.status)return null;throw e}).then(c).then(l).then(f)}var g,p,m=n.makeLogger("koast.user"),k=t,v={isAuthenticated:!1,isReady:!1,data:{},meta:{}},b=u.defer();return v.getUserData=h,v.saveToken=function(e,t){k.saveToken({token:e,expires:t})},v.initiateOauthAuthentication=function(t,n){e.initiateAuthentication(t,n)},v.logout=function(t){return k.deleteToken(),a.post(e.makeRequestURL("/auth/logout")).then(function(e){if("Ok"!==e.data)throw new Error("Failed to logout.");i.location.replace(t||"/")}).then(null,function(e){throw r.error(e),e})},v.loginLocal=function(t){r.debug("Login:",t.username);var n={username:t.username,password:t.password};return a.post(e.makeRequestURL("/auth/login"),n).then(function(e){return m.debug("loginLocal:",e),e.data}).then(l)},v.registerSocial=function(e){return k.put("/auth/user",e).then(function(e){return e.meta.token&&v.saveToken(e.meta.token,e.meta.expires),h()})},v.registerLocal=function(t){return a.post(e.makeRequestURL("/auth/user"),t)},v.checkUsernameAvailability=function(e){var t="/auth/usernameAvailable";return k.get(t,{params:{username:e}}).then(function(e){return e.data===!0}).then(null,function(){})},v.resetPassword=function(t){return a.post(e.makeRequestURL("/forgot"),{email:t})},v.setNewPassword=function(t,n){return a.post(e.makeRequestURL("/reset/"+n),{password:t})},v.setRegistrationHanler=function(e){g=e},v.getStatusPromise=function(){return p||(p=h()),p},v.whenStatusIsKnown=v.getStatusPromise,v.refreshToken=function(e,t){return k.get(e||"/auth/token/refresh").then(function(e){return e.token?(v.meta.token=e.token,e):t})},v.checkForToken=function(){var e=s.search().redirectToken;return e?(v.saveToken(e),v.refreshToken(null,e).then(function(e){return v.saveToken(e.token,e.expires)})):u.when({})},v.init=function(t){return t.debug=t.debug||{},v.debug=t.debug,e.setBaseUrl(t.baseUrl),v.checkForToken().then(v.getStatusPromise).then(d)},v.whenAuthenticated=function(){return b.promise},v}]);